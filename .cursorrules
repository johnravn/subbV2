# Project Rules for AI Agents

This project is primarily developed using AI agents. Follow these rules strictly.

## üö® CRITICAL: Database Migration Workflow

**ALL database schema changes MUST go through the migration workflow. Never make changes directly in the Supabase Dashboard.**

### Required Steps for ANY Database Change:

1. **Create migration**: `npm run db:migrate descriptive_name`
2. **Write SQL** in the generated migration file
3. **Test locally**: `npm run db:reset`
4. **Push to production**: `npm run db:push`
5. **Update types**: `npm run db:types:remote`

### RLS (Row Level Security) Requirements:

- **Every table MUST have RLS enabled**: `ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;`
- **Every table MUST have RLS policies** for SELECT, INSERT, UPDATE, DELETE
- **Always use idempotent SQL**: `DROP POLICY IF EXISTS` before creating policies
- **Follow the pattern**: Check `company_users` for company-scoped data, `profiles.user_id` for personal data, allow superusers

### Migration Best Practices:

- ‚úÖ One logical change per migration
- ‚úÖ Use descriptive names (e.g., `add_rls_to_addresses`)
- ‚úÖ Test locally before pushing
- ‚úÖ Use `IF EXISTS` / `IF NOT EXISTS` for idempotency
- ‚ùå Never edit applied migrations (create new one instead)
- ‚ùå Never skip RLS policies
- ‚ùå Never make schema changes in Dashboard without capturing as migration

## Code Style

- Use TypeScript for all new code
- Follow existing patterns in the codebase
- Use TanStack Query for data fetching
- Use Radix UI Themes for components
- Follow the feature-based folder structure in `src/features/`

## GitHub & Deployment Workflow

**ALL code changes must go through Pull Requests. Never push directly to `main`.**

### Pull Request Workflow

1. **Create feature branch**: `git checkout -b feature/description`
2. **Make changes**: Code, test locally
3. **Create migration** (if needed): `npm run db:migrate descriptive_name`
4. **Test locally**: `npm run db:reset && npm run dev`
5. **Push migration** (if backward-compatible): `npm run db:push` before merging
6. **Commit and push**: `git push origin feature/description`
7. **Create PR on GitHub**: Use the PR template
8. **Test preview deployment**: Vercel creates preview URL automatically
9. **Merge to main**: Only after testing preview - deploys to gridsolutions.app

### Vercel Deployments

- **Feature branches/PRs** ‚Üí Preview deployment (`grid-xxxxx.vercel.app`)
  - Use for testing before merging
  - Safe to break, not production
  
- **Main branch** ‚Üí Production deployment (`gridsolutions.app`)
  - Live production site
  - Only merge stable, tested code

**‚ö†Ô∏è CRITICAL**: Always test on preview URL before merging to `main`. Production deployments happen automatically when merging to `main`.

### PR Best Practices

- ‚úÖ One feature/fix per PR
- ‚úÖ Test on preview before merging
- ‚úÖ Fill out PR template completely
- ‚úÖ Document database changes
- ‚úÖ Verify build succeeds
- ‚ùå Never push directly to `main`
- ‚ùå Never merge broken previews
- ‚ùå Never skip testing

## Documentation

- **Deployment Workflow**: See `DEPLOYMENT_WORKFLOW.md` - Branch strategy, Vercel deployment, migration timing
- **Pull Requests**: See `GITHUB_PULL_REQUESTS.md` - Complete PR guide
- **Vercel Deployments**: See `VERCEL_DEPLOYMENTS.md` - Preview vs production explained
- **Migration Workflow**: See `CONTRIBUTING.md`
- **Supabase Development**: See `supabase/DEVELOPMENT_WORKFLOW.md`
- **Migrations Directory**: See `supabase/migrations/README.md`

## When Making Database Changes

**Before writing any SQL that modifies schema:**

1. Check `CONTRIBUTING.md` for the complete workflow
2. Check `supabase/migrations/README.md` for RLS patterns
3. Look at existing migrations for examples (e.g., `20250119000000_add_invoice_tracking.sql`)
4. Always create a migration file - never modify schema directly

## When Making Code Changes

**Before writing any code:**

1. Create a feature branch (never work directly on `main`)
2. Make your changes
3. Test locally (`npm run dev`)
4. Create PR with proper description
5. Test on Vercel preview URL
6. Only merge to `main` when preview is tested and working

---

**Remember**: 
- Database changes: Always create a migration file and test it locally first!
- Code changes: Always use feature branches and PRs, test on preview before merging!

